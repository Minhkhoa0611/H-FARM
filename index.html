<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tạo bài viết mới - Mật ong rừng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Be Vietnam Pro', Arial, sans-serif;
            background: linear-gradient(135deg, #e6f9e6 0%, #b6e5b6 100%);
            color: #2e3d1f;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            min-width: 100vw;
            box-sizing: border-box;
        }
        .container {
            width: 100vw;
            min-height: 100vh;
            margin: 0;
            background: #f8fff8;
            border-radius: 0;
            box-shadow: none;
            padding: 36px 2vw 32px 2vw;
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #388e3c;
            margin-bottom: 0;
            font-size: 2.3em;
            letter-spacing: 1px;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 2px 8px #b6e5b6;
        }
        .highlight { background: #e8fbe8; color: #388e3c; padding: 6px 12px; border-radius: 8px; display: block; text-align: center; margin: 0 auto 18px auto; font-size: 1.1em; font-weight: 500; box-shadow: 0 1px 4px #b6e5b6;}
        .product-img { display: block; margin: 18px auto 28px auto; width: 420px; height: 420px; object-fit: cover; border-radius: 16px; box-shadow: 0 4px 16px #b6e5b6; border: 3px solid #b6e5b6; background: #e8fbe8;}
        .section { margin-bottom: 28px; background: #e8fbe8; border-radius: 10px; padding: 18px 16px 10px 16px; box-shadow: 0 1px 6px #b6e5b6;}
        .price { color: #388e3c; font-size: 1.25em; font-weight: bold; margin-top: 10px; margin-bottom: 10px; letter-spacing: 0.5px;}
        .contact-btn { display: inline-block; background: linear-gradient(90deg, #43a047 0%, #66bb6a 100%); color: #fff; font-weight: 700; font-size: 1.1em; padding: 12px 32px; border-radius: 8px; text-decoration: none; box-shadow: 0 2px 8px #b6e5b6; margin-top: 18px;}
        .contact-btn:hover { background: linear-gradient(90deg, #388e3c 0%, #81c784 100%); transform: translateY(-2px) scale(1.03);}
        .form-group { margin-bottom: 18px; }
        label { font-weight: 500; display: block; margin-bottom: 6px; }
        input[type="text"], textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #b6e5b6; font-size: 1em; }
        textarea { min-height: 80px; }
        input[type="file"] { margin-top: 6px; }
        #preview { margin-top: 0; }
        .footer {
            margin-top: 36px;
            text-align: center;
            color: #388e3c;
            font-weight: 600;
            letter-spacing: 1px;
            font-size: 1.05em;
            opacity: 0.85;
        }
        .main-flex {
            display: flex;
            gap: 32px;
            align-items: flex-start;
            flex: 1 1 0;
        }
        .form-side {
            flex: 1 1 0;
            min-width: 0;
        }
        .preview-side {
            flex: 1 1 0;
            min-width: 0;
        }
        .preview-box {
            background: #e8fbe8;
            border: 2px solid #b6e5b6;
            border-radius: 14px;
            box-shadow: 0 2px 12px #b6e5b6;
            padding: 24px 18px;
            margin-top: 0;
            min-height: 200px;
        }
        .img-resize-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .img-resize-label {
            font-size: 0.98em;
            color: #388e3c;
            font-weight: 500;
            margin-right: 6px;
        }
        .img-resize-input {
            width: 60px;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #b6e5b6;
            font-size: 1em;
        }
        @media (max-width: 900px) {
            .main-flex { flex-direction: column; gap: 0; }
            .form-side, .preview-side { width: 100%; }
            #preview { margin-top: 36px; }
        }
        @media (max-width: 600px) {
            .container { padding: 14px 4vw 18px 4vw; }
            h1 { font-size: 1.4em; }
            .product-img { width: 180px; height: 180px; }
            .section { padding: 10px 6px 6px 6px; }
        }
    </style>
    <!-- Thêm thư viện QRCode.js và QRCodeStyling -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
</head>
<body>
        <nav style="width:100%;background:#eafbe7;padding:12px 0 10px 0;box-shadow:0 2px 8px rgba(45,122,45,0.04);margin-bottom:12px;">
        <div style="max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:flex-end;gap:12px;">
            <a href="index.html" style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                TẠO SẢN PHẨM
            </a>
            <a href="https://minhkhoa0611.github.io/quanlynhansu/QRSCANNER/qr-scanner.html" style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                QR SCANNER
            </a>
            <a href="https://www.canva.com/design/DAGr5jzmJAw/ZmChp88aCMXM8vCpzuS4_A/edit?utm_content=DAGr5jzmJAw&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton"
               style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                CANVA THIẾT KẾ
            </a>
        </div>
    </nav>
    <div class="container">
        <h1>Tạo bài viết mới</h1>
        <div class="main-flex">
            <div class="form-side">
                <form id="postForm">
                    <div class="form-group">
                        <label for="title">Tiêu đề bài viết</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-title"> Ẩn</label>
                        <input type="text" id="title" value="">
                    </div>
                    <div class="form-group">
                        <label for="highlight">Dòng phụ đề (highlight)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-highlight"> Ẩn</label>
                        <input type="text" id="highlight" value="">
                    </div>
                    <div class="form-group">
                        <label for="image">Chọn hình ảnh</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-image"> Ẩn</label>
                        <input type="file" id="image" accept="image/*" multiple>
                        <div id="image-list" style="margin:8px 0 0 0;display:flex;flex-wrap:wrap;gap:10px;"></div>
                        <div class="img-resize-wrap">
                            <span class="img-resize-label">Rộng</span>
                            <input type="number" id="imgWidth" class="img-resize-input" min="50" max="1000" value="420"> px
                            <span class="img-resize-label" style="margin-left:16px;">Cao</span>
                            <input type="number" id="imgHeight" class="img-resize-input" min="50" max="1000" value="420"> px
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="price">Giá bán (có thể xuống dòng bằng &lt;br&gt;)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-price"> Ẩn</label>
                        <textarea id="price" rows="2"></textarea>
                    </div>y
                    <div class="form-group">
                        <label for="contact">Số điện thoại liên hệ</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-contact"> Ẩn</label>
                        <input type="text" id="contact" value="">
                    </div>
                    <div class="form-group">
                        <label for="contactinfo">Thông tin liên hệ khác (hiển thị dưới chân trang, có thể để trống)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-contactinfo"> Ẩn</label>
                        <textarea id="contactinfo" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="origin">Nguồn gốc (mỗi ý 1 dòng, sẽ tự động thành danh sách)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-origin"> Ẩn</label>
                        <textarea id="origin" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="feature">Đặc điểm nổi bật (mỗi ý 1 dòng)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-feature"> Ẩn</label>
                        <textarea id="feature" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="benefit">Công dụng tuyệt vời (mỗi ý 1 dòng)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-benefit"> Ẩn</label>
                        <textarea id="benefit" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="usage">Cách sử dụng (mỗi ý 1 dòng)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-usage"> Ẩn</label>
                        <textarea id="usage" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="preserve">Bảo quản (mỗi ý 1 dòng)</label>
                        <label style="font-size:0.95em;display:inline;"><input type="checkbox" id="hide-preserve"> Ẩn</label>
                        <textarea id="preserve" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="footertext">Nội dung chân trang (footer)</label>
                        <input type="text" id="footertext" value="H'FARM - 95 QUẢNG ĐỨC - NHA TRANG  -KHÁNH HÒA">
                    </div>
                    <div class="form-group">
                        <label for="filename">Tên file (không có .html)</label>
                        <input type="text" id="filename" value="">
                    </div>
                    <button type="button" onclick="downloadHTML()">Tải về máy</button>
                    <button type="button" onclick="saveToGithub()">Lưu lên Github</button>
                    <div id="github-progress" style="margin-top:8px;color:#388e3c;font-size:1em;"></div>
                    <div id="github-link" style="margin-top:12px;font-size:1.05em;"></div>
                    <div id="qrcode-box" style="margin-top:18px;text-align:center;"></div>
                    <button id="download-qrcode-btn" type="button" style="display:none;margin-top:10px;">Download mã QR</button>
                    <div class="form-group" style="margin-top:32px;">
                        <label for="loadfilename">Tải & chỉnh sửa file từ Github</label>
                        <input type="text" id="loadfilename" placeholder="Nhập tên file (không .html)">
                        <button type="button" id="loadFromGithubBtn">Tải file từ Github</button>
                        <span id="load-status" style="margin-left:8px;color:#388e3c;font-size:0.98em;"></span>
                    </div>
                </form>
            </div>
            <div class="preview-side">
                <h2 style="margin-top:0;">Preview</h2>
                <div class="preview-box">
                    <div id="preview"></div>
                </div>
            </div>
        </div>
        <div class="footer" id="footer-main"><span id="footer-content"></span><span id="footer-contactinfo"></span></div>
    </div>
    <script>
        // Lấy các trường nhập liệu
        const titleInput = document.getElementById('title');
        const highlightInput = document.getElementById('highlight');
        const imageInput = document.getElementById('image');
        const priceInput = document.getElementById('price');
        const contactInput = document.getElementById('contact');
        const originInput = document.getElementById('origin');
        const featureInput = document.getElementById('feature');
        const benefitInput = document.getElementById('benefit');
        const usageInput = document.getElementById('usage');
        const preserveInput = document.getElementById('preserve');
        const filenameInput = document.getElementById('filename');
        const previewDiv = document.getElementById('preview');
        const contactInfoInput = document.getElementById('contactinfo');
        const imgWidthInput = document.getElementById('imgWidth');
        const imgHeightInput = document.getElementById('imgHeight');
        const footerTextInput = document.getElementById('footertext');
        const loadFilenameInput = document.getElementById('loadfilename');
        const loadFromGithubBtn = document.getElementById('loadFromGithubBtn');
        const loadStatus = document.getElementById('load-status');
        const imageListDiv = document.getElementById('image-list');

        // Thêm các checkbox ẩn/hiện
        const hideTitle = document.getElementById('hide-title');
        const hideHighlight = document.getElementById('hide-highlight');
        const hideImage = document.getElementById('hide-image');
        const hidePrice = document.getElementById('hide-price');
        const hideContact = document.getElementById('hide-contact');
        const hideContactInfo = document.getElementById('hide-contactinfo');
        const hideOrigin = document.getElementById('hide-origin');
        const hideFeature = document.getElementById('hide-feature');
        const hideBenefit = document.getElementById('hide-benefit');
        const hideUsage = document.getElementById('hide-usage');
        const hidePreserve = document.getElementById('hide-preserve');

        let imageDataUrls = [];
        let uploadedImageUrls = []; // Đường dẫn ảnh trên Github nếu upload file ảnh

        // Xử lý chọn nhiều ảnh, cho phép thêm ảnh mới mà không xóa ảnh cũ
        imageInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length) {
                let loaded = 0;
                let newImages = [];
                files.forEach((file, idx) => {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        newImages[idx] = evt.target.result;
                        loaded++;
                        if (loaded === files.length) {
                            imageDataUrls = imageDataUrls.concat(newImages);
                            updateImageList();
                            updatePreview();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }
            // reset input file để lần sau chọn lại cùng file vẫn được
            imageInput.value = '';
        });

        // Hiển thị danh sách ảnh đã chọn và nút xóa
        function updateImageList() {
            imageListDiv.innerHTML = '';
            imageDataUrls.forEach((img, idx) => {
                const wrap = document.createElement('div');
                wrap.style.position = 'relative';
                wrap.style.display = 'inline-block';
                wrap.style.width = '60px';
                wrap.style.height = '60px';
                wrap.style.border = '1px solid #b6e5b6';
                wrap.style.borderRadius = '6px';
                wrap.style.overflow = 'hidden';
                wrap.style.background = '#fff';
                wrap.style.boxShadow = '0 1px 4px #b6e5b6';
                // Ảnh nhỏ
                const image = document.createElement('img');
                image.src = img;
                image.style.width = '100%';
                image.style.height = '100%';
                image.style.objectFit = 'cover';
                // Nút xóa
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '×';
                btn.title = 'Xóa ảnh này';
                btn.style.position = 'absolute';
                btn.style.top = '0';
                btn.style.right = '0';
                btn.style.background = '#e53935';
                btn.style.color = '#fff';
                btn.style.border = 'none';
                btn.style.borderRadius = '0 0 0 6px';
                btn.style.width = '22px';
                btn.style.height = '22px';
                btn.style.cursor = 'pointer';
                btn.style.fontWeight = 'bold';
                btn.style.fontSize = '18px';
                btn.style.lineHeight = '18px';
                btn.onclick = function() {
                    imageDataUrls.splice(idx, 1);
                    updateImageList();
                    updatePreview();
                    // reset input file nếu không còn ảnh nào
                    if (imageDataUrls.length === 0) imageInput.value = '';
                };
                wrap.appendChild(image);
                wrap.appendChild(btn);
                imageListDiv.appendChild(wrap);
            });
        }

        // Cập nhật preview khi nhập liệu hoặc đổi trạng thái ẩn/hiện
        [
            titleInput, highlightInput, priceInput, contactInput,
            originInput, featureInput, benefitInput, usageInput, preserveInput, contactInfoInput,
            imgWidthInput, imgHeightInput,
            hideTitle, hideHighlight, hideImage, hidePrice, hideContact, hideContactInfo,
            hideOrigin, hideFeature, hideBenefit, hideUsage, hidePreserve,
            footerTextInput // thêm vào đây để cập nhật preview khi đổi chân trang
        ].forEach(input => {
            input.addEventListener('input', updatePreview);
            input.addEventListener('change', updatePreview);
        });

        // Lưu trạng thái ẩn/hiện vào localStorage khi thay đổi
        [
            hideTitle, hideHighlight, hideImage, hidePrice, hideContact, hideContactInfo,
            hideOrigin, hideFeature, hideBenefit, hideUsage, hidePreserve
        ].forEach(input => {
            input.addEventListener('change', () => {
                localStorage.setItem('hfarm_hide_' + input.id, input.checked ? '1' : '0');
            });
        });

        // Khi load trang, khôi phục trạng thái ẩn/hiện từ localStorage
        window.addEventListener('DOMContentLoaded', () => {
            [
                hideTitle, hideHighlight, hideImage, hidePrice, hideContact, hideContactInfo,
                hideOrigin, hideFeature, hideBenefit, hideUsage, hidePreserve
            ].forEach(input => {
                const val = localStorage.getItem('hfarm_hide_' + input.id);
                if (val === '1') input.checked = true;
                else if (val === '0') input.checked = false;
            });
            updatePreview();
        });

        function toList(text) {
            return text.split('\n').filter(x => x.trim()).map(x => `<li>${x.trim()}</li>`).join('');
        }

        function updatePreview() {
            let html = '';
            if (!hideTitle.checked) html += `<h1>${titleInput.value}</h1>`;
            if (!hideHighlight.checked) html += `<div class="highlight">${highlightInput.value}</div>`;
            // Hiển thị ảnh theo hàng, mỗi hàng 3 ảnh
            if (!hideImage.checked && imageDataUrls.length) {
                html += `<div class="img-row-wrap" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;margin-bottom:18px;">`;
                imageDataUrls.forEach((img, idx) => {
                    html += `<div style="flex:0 0 calc(33.333% - 12px);max-width:calc(33.333% - 12px);box-sizing:border-box;display:flex;justify-content:center;">
                        <img class="product-img" id="preview-img-${idx}" src="${img}" alt="Ảnh sản phẩm" style="width:${imgWidthInput.value}px;height:${imgHeightInput.value}px;resize:both;overflow:auto;display:block;">
                    </div>`;
                });
                html += `</div>`;
            }
            if (!hidePrice.checked || !hideContact.checked) {
                html += `<div class="section" style="text-align:center; margin-bottom: 24px;">`;
                if (!hidePrice.checked) {
                    html += `<h2>💰 GIÁ BÁN</h2><div class="price">${priceInput.value}</div>`;
                }
                if (!hideContact.checked) {
                    html += `<a class="contact-btn" href="tel:${contactInput.value}">Liên hệ mua hàng</a>`;
                }
                html += `</div>`;
            }
            if (!hideOrigin.checked) {
                html += `<div class="section"><h2>🏞️ NGUỒN GỐC</h2><ul>${toList(originInput.value)}</ul></div>`;
            }
            if (!hideFeature.checked) {
                html += `<div class="section"><h2>💎 ĐẶC ĐIỂM NỔI BẬT</h2><ul>${toList(featureInput.value)}</ul></div>`;
            }
            if (!hideBenefit.checked) {
                html += `<div class="section"><h2>✅ CÔNG DỤNG TUYỆT VỜI</h2><ul>${toList(benefitInput.value)}</ul></div>`;
            }
            if (!hideUsage.checked) {
                html += `<div class="section"><h2>👌 CÁCH SỬ DỤNG</h2><ul>${toList(usageInput.value)}</ul></div>`;
            }
            if (!hidePreserve.checked) {
                html += `<div class="section"><h2>📦 BẢO QUẢN</h2><ul>${toList(preserveInput.value)}</ul></div>`;
            }
            // Thêm phần chân trang vào preview
            const footerText = footerTextInput.value || '';
            const contactInfo = (!hideContactInfo.checked && contactInfoInput.value) ? ' - ' + contactInfoInput.value : '';
            html += `<div class="footer" style="margin-top:36px;text-align:center;color:#388e3c;font-weight:600;letter-spacing:1px;font-size:1.05em;opacity:0.85;">${footerText}${contactInfo}</div>`;

            previewDiv.innerHTML = html;
            // Cho phép kéo chỉnh kích thước ảnh đầu tiên trong preview
            const previewImg = document.getElementById('preview-img-0');
            if (previewImg) {
                previewImg.style.resize = "both";
                previewImg.style.overflow = "auto";
                previewImg.onmouseup = function () {
                    setTimeout(() => {
                        imgWidthInput.value = previewImg.offsetWidth;
                        imgHeightInput.value = previewImg.offsetHeight;
                    }, 10);
                };
            }
        }

        // Khởi tạo preview ban đầu
        updatePreview();

        // Hàm lấy nội dung HTML xuất file
        function getExportHtml() {
            const filename = filenameInput.value.trim() || 'bai-viet-moi';
            let html = '';
            // Sử dụng uploadedImageUrls nếu có, nếu không dùng base64
            let imgSrcs = uploadedImageUrls.length ? uploadedImageUrls : imageDataUrls;
            if (!hideTitle.checked) html += `<h1>${titleInput.value}</h1>\n`;
            if (!hideHighlight.checked) html += `<div class="highlight">${highlightInput.value}</div>\n`;
            if (!hideImage.checked && imgSrcs.length) {
                html += `<div class="img-row-wrap" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;margin-bottom:18px;">`;
                imgSrcs.forEach(imgSrc => {
                    html += `<div style="flex:0 0 calc(33.333% - 12px);max-width:calc(33.333% - 12px);box-sizing:border-box;display:flex;justify-content:center;">
                        <img class="product-img" src="${imgSrc}" alt="Ảnh sản phẩm" style="width:${imgWidthInput.value}px;height:${imgHeightInput.value}px;">
                    </div>`;
                });
                html += `</div>\n`;
            }
            if (!hidePrice.checked || !hideContact.checked) {
                html += `<div class="section" style="text-align:center; margin-bottom: 24px;">\n`;
                if (!hidePrice.checked) {
                    html += `<h2>💰 GIÁ BÁN</h2>\n<div class="price">${priceInput.value}</div>\n`;
                }
                if (!hideContact.checked) {
                    html += `<a class="contact-btn" href="tel:${contactInput.value}">Liên hệ mua hàng</a>\n`;
                }
                html += `</div>\n`;
            }
            if (!hideOrigin.checked) {
                html += `<div class="section">\n<h2>🏞️ NGUỒN GỐC</h2>\n<ul>${toList(originInput.value)}</ul>\n</div>\n`;
            }
            if (!hideFeature.checked) {
                html += `<div class="section">\n<h2>💎 ĐẶC ĐIỂM NỔI BẬT</h2>\n<ul>${toList(featureInput.value)}</ul>\n</div>\n`;
            }
            if (!hideBenefit.checked) {
                html += `<div class="section">\n<h2>✅ CÔNG DỤNG TUYỆT VỜI</h2>\n<ul>${toList(benefitInput.value)}</ul>\n</div>\n`;
            }
            if (!hideUsage.checked) {
                html += `<div class="section">\n<h2>👌 CÁCH SỬ DỤNG</h2>\n<ul>${toList(usageInput.value)}</ul>\n</div>\n`;
            }
            if (!hidePreserve.checked) {
                html += `<div class="section">\n<h2>📦 BẢO QUẢN</h2>\n<ul>${toList(preserveInput.value)}</ul>\n</div>\n`;
            }
            const contactInfo = (!hideContactInfo.checked && contactInfoInput.value) ? ' - ' + contactInfoInput.value : '';
            const footerText = footerTextInput.value || '';
            return `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>${!hideTitle.checked ? titleInput.value : ''} – ${!hideHighlight.checked ? highlightInput.value : ''}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ...copy style từ trên... */
        body { font-family: 'Be Vietnam Pro', Arial, sans-serif; background: linear-gradient(135deg, #e6f9e6 0%, #b6e5b6 100%); color: #2e3d1f; margin: 0; padding: 0;}
        .container { max-width: 750px; margin: 40px auto; background: #f8fff8; border-radius: 18px; box-shadow: 0 8px 32px 0 rgba(184,134,11,0.18), 0 1.5px 6px #e0c97f; padding: 36px 28px 32px 28px; position: relative;}
        h1 { color: #388e3c; margin-bottom: 0; font-size: 2.3em; letter-spacing: 1px; text-align: center; font-weight: 700; text-shadow: 0 2px 8px #b6e5b6;}
        .highlight { background: #e8fbe8; color: #388e3c; padding: 6px 12px; border-radius: 8px; display: block; text-align: center; margin: 0 auto 18px auto; font-size: 1.1em; font-weight: 500; box-shadow: 0 1px 4px #b6e5b6;}
        .product-img { display: block; margin: 18px auto 28px auto; object-fit: cover; border-radius: 16px; box-shadow: 0 4px 16px #b6e5b6; border: 3px solid #b6e5b6; background: #e8fbe8;}
        .section { margin-bottom: 28px; background: #e8fbe8; border-radius: 10px; padding: 18px 16px 10px 16px; box-shadow: 0 1px 6px #b6e5b6;}
        .price { color: #388e3c; font-size: 1.25em; font-weight: bold; margin-top: 10px; margin-bottom: 10px; letter-spacing: 0.5px;}
        .contact-btn { display: inline-block; background: linear-gradient(90deg, #43a047 0%, #66bb6a 100%); color: #fff; font-weight: 700; font-size: 1.1em; padding: 12px 32px; border-radius: 8px; text-decoration: none; box-shadow: 0 2px 8px #b6e5b6; margin-top: 18px;}
        .contact-btn:hover { background: linear-gradient(90deg, #388e3c 0%, #81c784 100%); transform: translateY(-2px) scale(1.03);}
        .footer { margin-top: 36px; text-align: center; color: #388e3c; font-weight: 600; letter-spacing: 1px; font-size: 1.05em; opacity: 0.85;}
        .main-flex {
            display: flex;
            gap: 32px;
            align-items: flex-start;
        }
        .form-side {
            flex: 1 1 0;
            min-width: 0;
        }
        .preview-side {
            flex: 1 1 0;
            min-width: 0;
        }
        .preview-box {
            background: #e8fbe8;
            border: 2px solid #b6e5b6;
            border-radius: 14px;
            box-shadow: 0 2px 12px #b6e5b6;
            padding: 24px 18px;
            margin-top: 0;
            min-height: 200px;
        }
        @media (max-width: 900px) {
            .main-flex { flex-direction: column; gap: 0; }
            .form-side, .preview-side { width: 100%; }
            #preview { margin-top: 36px; }
        }
        @media (max-width: 600px) {
            .container { padding: 14px 4vw 18px 4vw; }
            h1 { font-size: 1.4em; }
            .product-img { width: 180px; height: 180px; }
            .section { padding: 10px 6px 6px 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        ${html}
        <div class="footer">${footerText}${contactInfo}</div>
    </div>
</body>
</html>
            `.trim();
        }

        // Tạo file HTML và tải về
        function downloadHTML() {
            const filename = filenameInput.value.trim() || 'bai-viet-moi';
            const htmlContent = getExportHtml();
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.html';
            link.click();
        }

        // Lưu lên Github qua Google Apps Script
        function saveToGithub() {
            const filename = filenameInput.value.trim() || 'bai-viet-moi';
            const githubImagePath = `posts/images/${filename}_image`;
            const githubImageUrl = `https://raw.githubusercontent.com/Minhkhoa0611/H-FARM/main/posts/images/${filename}_image`;
            const githubPath = `posts/${filename}.html`;
            const githubWebUrl = `https://minhkhoa0611.github.io/H-FARM/posts/${filename}.html`;
            const githubLinkDiv = document.getElementById('github-link');
            const githubProgressDiv = document.getElementById('github-progress');
            const qrcodeBox = document.getElementById('qrcode-box');
            const downloadQrBtn = document.getElementById('download-qrcode-btn');

            githubLinkDiv.innerHTML = "";
            githubProgressDiv.textContent = "Đang lấy token Github...";
            qrcodeBox.innerHTML = ""; // Xóa QR cũ nếu có
            downloadQrBtn.style.display = "none";
            uploadedImageUrls = []; // reset

            // Nếu có ảnh lớn hơn 1MB, upload từng ảnh lên Github
            if (imageDataUrls.length && imageDataUrls.some(img => img && img.length > 1200000)) {
                let filesToUpload = imageDataUrls.map((img, idx) => ({
                    dataUrl: img,
                    idx
                })).filter(imgObj => imgObj.dataUrl && imgObj.dataUrl.length > 1200000);
                let extArr = imageDataUrls.map(img => {
                    const match = img && img.match(/^data:image\/(\w+);base64,/);
                    return match ? '.' + match[1].toLowerCase() : '.png';
                });
                let imgPaths = extArr.map((ext, idx) => `posts/images/${filenameInput.value.trim() || 'bai-viet-moi'}_image${idx+1}${ext}`);
                let imgUrls = extArr.map((ext, idx) => `https://raw.githubusercontent.com/Minhkhoa0611/H-FARM/main/posts/images/${filenameInput.value.trim() || 'bai-viet-moi'}_image${idx+1}${ext}`);
                const githubProgressDiv = document.getElementById('github-progress');
                githubProgressDiv.textContent = "Ảnh lớn, đang upload ảnh lên Github...";
                fetch('https://script.google.com/macros/s/AKfycbwUZ5jzf34qM4fWIiCaWFUElqRnkMuQqGgITrr0KdE0pMmfo9ejeWEFCLFzmL4okYwi/exec')
                    .then(res => res.text())
                    .then(text => {
                        let token = '';
                        const match = text.match(/Token đã lưu:\s*([a-zA-Z0-9_]+)/);
                        if (match) token = match[1];
                        if (!token) {
                            githubProgressDiv.textContent = "Không lấy được token Github!";
                            return;
                        }
                        // Upload từng ảnh
                        let uploadCount = 0;
                        uploadedImageUrls = [...imageDataUrls]; // fallback: base64
                        filesToUpload.forEach((imgObj, i) => {
                            fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${imgPaths[imgObj.idx]}`, {
                                headers: { Authorization: `token ${token}` }
                            })
                            .then(res => res.ok ? res.json() : null)
                            .then(fileData => {
                                const body = {
                                    message: `Add image for post ${filenameInput.value.trim() || 'bai-viet-moi'}`,
                                    content: imgObj.dataUrl.split(',')[1],
                                    branch: "main"
                                };
                                if (fileData && fileData.sha) body.sha = fileData.sha;
                                fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${imgPaths[imgObj.idx]}`, {
                                    method: "PUT",
                                    headers: {
                                        "Authorization": `token ${token}`,
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify(body)
                                })
                                .then(r => r.json())
                                .then(resp => {
                                    if (resp.content && resp.content.download_url) {
                                        uploadedImageUrls[imgObj.idx] = imgUrls[imgObj.idx];
                                    }
                                    uploadCount++;
                                    if (uploadCount === filesToUpload.length) {
                                        githubProgressDiv.textContent = "Đã upload ảnh, đang lưu HTML...";
                                        saveHtmlWithImage(token, filenameInput.value.trim() || 'bai-viet-moi', `posts/${filenameInput.value.trim() || 'bai-viet-moi'}.html`, `https://minhkhoa0611.github.io/H-FARM/posts/${filenameInput.value.trim() || 'bai-viet-moi'}.html`, document.getElementById('github-link'), githubProgressDiv, document.getElementById('qrcode-box'), document.getElementById('download-qrcode-btn'));
                                    }
                                });
                            });
                        });
                    });
                return;
            }
            // Nếu không có ảnh lớn, xử lý như cũ
            uploadedImageUrls = '';
            // Để tránh lặp code, tách đoạn upload HTML ra hàm riêng:
            fetch('https://script.google.com/macros/s/AKfycbwUZ5jzf34qM4fWIiCaWFUElqRnkMuQqGgITrr0KdE0pMmfo9ejeWEFCLFzmL4okYwi/exec')
                .then(res => res.text())
                .then(text => {
                    let token = '';
                    const match = text.match(/Token đã lưu:\s*([a-zA-Z0-9_]+)/);
                    if (match) token = match[1];
                    if (!token) {
                        githubProgressDiv.textContent = "Không lấy được token Github!";
                        return;
                    }
                    saveHtmlWithImage(token, filename, githubPath, githubWebUrl, githubLinkDiv, githubProgressDiv, qrcodeBox, downloadQrBtn);
                })
                .catch(() => {
                    githubProgressDiv.textContent = "Không lấy được token Github!";
                });
        }

        // Hàm upload HTML (dùng uploadedImageUrls nếu có)
        function saveHtmlWithImage(token, filename, githubPath, githubWebUrl, githubLinkDiv, githubProgressDiv, qrcodeBox, downloadQrBtn) {
            githubProgressDiv.textContent = "Đang kiểm tra file trên Github...";
            fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                headers: { Authorization: `token ${token}` }
            })
            .then(res => res.ok ? res.json() : null)
            .then (fileData => {
                githubProgressDiv.textContent = "Đang tải file lên Github...";
                const htmlContent = getExportHtml();
                const body = {
                    message: `Add post ${filename}.html`,
                    content: btoa(unescape(encodeURIComponent(htmlContent))),
                    branch: "main"
                };
                if (fileData && fileData.sha) body.sha = fileData.sha;
                fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                })
                .then(r => r.json())
                .then(resp => {
                    if (resp.content && resp.content.download_url) {
                        githubProgressDiv.textContent = "Đã lưu lên Github thành công!";
                        githubLinkDiv.innerHTML = `<a href="${githubWebUrl}" target="_blank" style="color:#388e3c;font-weight:600;text-decoration:underline;">Xem bài viết trên web: ${githubWebUrl}</a>`;
                        qrcodeBox.innerHTML = "";
                        downloadQrBtn.style.display = "none";
                        // Sử dụng QRCodeStyling nếu có, nếu không fallback QRCode.js
                        if (window.QRCodeStyling) {
                            const qr = new QRCodeStyling({
                                width: 400,
                                height: 400,
                                data: githubWebUrl,
                                image: "image.png",
                                dotsOptions: { color: "#000000", type: "rounded" },
                                backgroundOptions: { color: "#e6f9e6" }, // nền xanh giống trang
                                cornersSquareOptions: { type: "extra-rounded", color: "#000000" },
                                cornersDotOptions: { type: "dot", color: "#000000" },
                                imageOptions: {
                                    crossOrigin: "anonymous",
                                    margin: 2,
                                    imageSize: 0.28,
                                    hideBackgroundDots: false,
                                    borderRadius: 16
                                }
                            });
                            qr.append(qrcodeBox);
                            downloadQrBtn.style.display = "inline-block";
                            downloadQrBtn.onclick = function() {
                                qr.download({ name: "qrcode", extension: "png" });
                            };
                        } else if (window.QRCode) {
                            new QRCode(qrcodeBox, {
                                text: githubWebUrl,
                                width: 400,
                                height: 400,
                                colorDark : "#000000",
                                colorLight : "#e6f9e6", // nền xanh giống trang
                                correctLevel : QRCode.CorrectLevel.H
                            });
                            qrcodeBox.innerHTML += '<div style="font-size:0.95em;color:#888;margin-top:4px;">(Không hỗ trợ logo ở giữa)</div>';
                            downloadQrBtn.style.display = "none";
                        }
                    } else {
                        githubProgressDiv.textContent = "Lưu lên Github thất bại! " + (resp.message || '');
                        githubLinkDiv.innerHTML = "";
                        qrcodeBox.innerHTML = "";
                        downloadQrBtn.style.display = "none";
                    }
                })
                .catch(() => {
                    githubProgressDiv.textContent = "Lỗi khi tải file lên Github!";
                    githubLinkDiv.innerHTML = "";
                    qrcodeBox.innerHTML = "";
                    downloadQrBtn.style.display = "none";
                });
            });
        }

        // Hàm parse HTML và điền vào form
        function fillFormFromHtml(html) {
            // Tạo DOM ảo để parse
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            // Lấy các trường
            const getVal = (selector) => {
                const el = doc.querySelector(selector);
                return el ? el.textContent.trim() : '';
            };
            const getImgs = () => {
                const imgs = doc.querySelectorAll('.product-img');
                return Array.from(imgs).map(img => img.src);
            };
            titleInput.value = getVal('h1');
            highlightInput.value = getVal('.highlight');
            imageDataUrls = getImgs();
            updateImageList();
            // Lấy width/height nếu có
            const img = doc.querySelector('.product-img');
            if (img) {
                imgWidthInput.value = img.width || img.style.width.replace('px','') || 420;
                imgHeightInput.value = img.height || img.style.height.replace('px','') || 420;
            }
            priceInput.value = getVal('.price');
            contactInput.value = '';
            const contactBtn = doc.querySelector('.contact-btn');
            if (contactBtn && contactBtn.href && contactBtn.href.startsWith('tel:')) {
                contactInput.value = contactBtn.href.replace('tel:','');
            }
            // Lấy đúng các danh sách section có <ul>
            const sections = Array.from(doc.querySelectorAll('.section')).filter(sec => sec.querySelector('ul'));
            originInput.value   = sections[0] ? Array.from(sections[0].querySelectorAll('li')).map(li => li.textContent).join('\n') : '';
            featureInput.value  = sections[1] ? Array.from(sections[1].querySelectorAll('li')).map(li => li.textContent).join('\n') : '';
            benefitInput.value  = sections[2] ? Array.from(sections[2].querySelectorAll('li')).map(li => li.textContent).join('\n') : '';
            usageInput.value    = sections[3] ? Array.from(sections[3].querySelectorAll('li')).map(li => li.textContent).join('\n') : '';
            preserveInput.value = sections[4] ? Array.from(sections[4].querySelectorAll('li')).map(li => li.textContent).join('\n') : '';
            // Footer
            const footer = doc.querySelector('.footer');
            if (footer) {
                // Tách contactinfo nếu có, nhưng KHÔNG lấy nếu là chuỗi rỗng hoặc chỉ có 1 phần
                const txt = footer.textContent.trim();
                // Nếu có ' - ' và phía sau còn ký tự, mới gán vào contactInfoInput
                const idx = txt.indexOf(' - ');
                if (idx >= 0 && txt.slice(idx + 3).trim()) {
                    footerTextInput.value = txt.slice(0, idx);
                    contactInfoInput.value = txt.slice(idx + 3);
                } else {
                    footerTextInput.value = txt;
                    contactInfoInput.value = '';
                }
            }
            // filename
            filenameInput.value = loadFilenameInput.value.trim();
            updatePreview();
        }

        // Nút tải file từ Github
        loadFromGithubBtn.onclick = function() {
            const filename = loadFilenameInput.value.trim();
            if (!filename) {
                loadStatus.textContent = "Nhập tên file!";
                return;
            }
            loadStatus.textContent = "Đang tải file...";
            fetch(`https://raw.githubusercontent.com/Minhkhoa0611/H-FARM/main/posts/${filename}.html`)
                .then(res => {
                    if (!res.ok) throw new Error("Không tìm thấy file!");
                    return res.text();
                })
                .then(html => {
                    fillFormFromHtml(html);
                    loadStatus.textContent = "Đã tải xong!";
                })
                .catch(e => {
                    loadStatus.textContent = "Lỗi: " + e.message;
                });
        };
    </script>
</body>

</html>
Phiên bản phần mềm 1.0 BY MINH KHOA