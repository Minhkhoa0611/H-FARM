<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh S√°ch S·∫£n Ph·∫©m</title>
    <link rel="icon" type="image/x-icon" href="image.png">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f7fcf6;
            margin: 0;
            padding: 0;
        }
        h1 {
            color: #217a21;
            text-align: center;
            margin-top: 18px;
            margin-bottom: 18px;
            font-size: 2em;
            letter-spacing: 1px;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            padding: 0 12px;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 50px 30px;
            margin: 25px 0;
        }
        .product-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(45,122,45,0.08);
            padding: 18px 14px 16px 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: box-shadow 0.2s;
            min-height: 370px; /* ƒê·∫£m b·∫£o c√°c card cao ƒë·ªÅu nhau */
            height: 100%;
        }
        .product-card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1 1 auto;
            width: 100%;
        }
        .product-img {
            width: 100%;
            max-width: 100%;
            height: 220px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #f2f8f2;
            display: block;
        }
        .product-title {
            font-weight: bold;
            color: #217a21;
            font-size: 1.08em;
            margin-bottom: 6px;
            text-align: center;
            min-height: 2.5em; /* ƒê·∫£m b·∫£o t√™n s·∫£n ph·∫©m kh√¥ng l√†m l·ªách card */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .product-price-list {
            margin-bottom: 8px;
            width: 100%;
            min-height: 2.2em; /* ƒê·∫£m b·∫£o v√πng gi√° lu√¥n c√≥ chi·ªÅu cao */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            font-size: 1em;
            margin-bottom: 2px;
        }
        .product-note {
            color: #888;
            font-size: 0.97em;
            margin-bottom: 8px;
            text-align: center;
            min-height: 1.2em;
        }
        .product-detail-link {
            margin-bottom: 8px;
            display: inline-block;
            min-height: 1.2em;
        }
        .add-to-cart-btn {
            width: 100%;
            margin-top: auto;
        }
        /* ƒê·∫£m b·∫£o c√°c card lu√¥n cao ƒë·ªÅu nhau trong grid */
        .product-grid > .product-card {
            height: 100%;
        }
        /* Cart popup */
        #cart-popup {
            animation: fadeInCart 0.18s;
        }
        @keyframes fadeInCart {
            from { opacity: 0; transform: translateY(-16px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .cart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.98em;
        }
        .cart-table th, .cart-table td {
            border: 1px solid #e0f2e0;
            padding: 4px 6px;
            text-align: center;
        }
        .cart-table th {
            background: #eafbe7;
            color: #217a21;
        }
        .cart-total-row td {
            font-weight: bold;
            color: #217a21;
            background: #f2f8f2;
        }
        .cart-buy-btn {
            margin-top: 12px;
            background: #217a21;
            color: #fff;
            border: none;
            padding: 8px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.08em;
            width: 100%;
        }
        /* Price popup */
        .price-popup-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.18);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .price-popup {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(45,122,45,0.18);
            padding: 24px 22px 16px 22px;
            min-width: 220px;
            max-width: 90vw;
            text-align: center;
        }
        .price-popup h3 {
            color: #217a21;
            margin-bottom: 12px;
            font-size: 1.08em;
        }
        #popup-price-select {
            width: 90%;
            padding: 7px;
            border-radius: 6px;
            border: 1px solid #b6e5b6;
            font-size: 1em;
        }
        #popup-add-cart-btn {
            background: #217a21;
            color: #fff;
            border: none;
            padding: 7px 22px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            margin-right: 8px;
        }
        .cancel-btn {
            background: #bdbdbd;
            color: #333;
            border: none;
            padding: 7px 22px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
        }
        /* Responsive styles */
        @media (max-width: 1200px) {
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (max-width: 900px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 32px 14px; /* tƒÉng kho·∫£ng c√°ch h√†ng tr√™n mobile/tablet */
            }
            .container {
                max-width: 99vw;
            }
        }
        @media (max-width: 700px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 22px 8px;
            }
        }
        @media (max-width: 480px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 18px;
            }
            .product-card {
                padding: 12px 7px 12px 7px;
                min-height: 0;
            }
            .product-img {
                max-width: 100vw;
                height: 180px;
            }
            h1 {
                font-size: 1.25em;
                margin-top: 10px;
                margin-bottom: 10px;
            }
            .cart-table th, .cart-table td {
                font-size: 0.95em;
                padding: 3px 2px;
            }
            .price-popup {
                padding: 14px 6px 10px 6px;
                min-width: 0;
            }
        }
        /* Scrollbar style for popup */
        #cart-popup, #my-orders-popup > div {
            scrollbar-width: thin;
            scrollbar-color: #b6e5b6 #f7fcf6;
        }
        #cart-popup::-webkit-scrollbar, #my-orders-popup > div::-webkit-scrollbar {
            width: 7px;
            background: #f7fcf6;
        }
        #cart-popup::-webkit-scrollbar-thumb, #my-orders-popup > div::-webkit-scrollbar-thumb {
            background: #b6e5b6;
            border-radius: 8px;
        }
        /* Footer */
        footer {
            margin-top: 32px;
            margin-bottom: 12px;
            font-size: 1em;
            color: #2d7a2d;
            letter-spacing: 1px;
        }
        /* --- NAV RESPONSIVE --- */
        @media (max-width: 900px) {
            nav {
                padding: 7px 0 6px 0 !important;
            }
            nav > div {
                max-width: 99vw !important;
                gap: 6px !important;
            }
            nav a, nav button#view-my-orders-btn {
                font-size: 0.98em !important;
                padding: 5px 10px !important;
            }
        }
        @media (max-width: 700px) {
            nav {
                padding: 4px 0 3px 0 !important;
            }
            nav > div {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 4px !important;
            }
            nav > div > div {
                justify-content: center !important;
                flex-wrap: wrap !important;
            }
            nav a, nav button#view-my-orders-btn {
                font-size: 0.93em !important;
                padding: 4px 7px !important;
                margin-bottom: 2px !important;
            }
            #cart-count {
                font-size: 0.85em !important;
                padding: 1px 5px !important;
                top: 1px !important;
                right: 1px !important;
            }
        }
        @media (max-width: 480px) {
            nav {
                padding: 2px 0 2px 0 !important;
            }
            nav a, nav button#view-my-orders-btn {
                font-size: 0.89em !important;
                padding: 3px 4px !important;
            }
        }
    </style>

</head>
<body>
    <nav style="width:100%;background:#eafbe7;padding:12px 0 10px 0;box-shadow:0 2px 8px rgba(45,122,45,0.04);margin-bottom:12px;">
        <div style="max-width:950px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <!-- Logo b√™n tr√°i -->
            <div style="display:flex;align-items:center;gap:8px;">
                <img src="image.png" alt="H'FARM Logo" style="height:38px;width:auto;border-radius:8px;box-shadow:0 1px 4px #b6e5b6;">
                <span style="font-weight:bold;color:#217a21;font-size:1.18em;letter-spacing:1px;">H'FARM</span>
            </div>
            <!-- Menu b√™n ph·∫£i -->
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <a href="danhsachsanpham.html" style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;background:#d6f5d6;">
                    DANH M·ª§C S·∫¢N PH·∫®M
                </a>
                <button id="view-my-orders-btn" title="Xem ƒë∆°n h√†ng ƒë√£ ƒë·∫∑t" style="background:none;border:none;outline:none;cursor:pointer;display:flex;align-items:center;gap:4px;padding:0 8px;transition:background 0.2s;border-radius:6px;">
                    <span style="font-size:1.35em;vertical-align:middle;">üöö</span>
                    <span style="color:#217a21;font-weight:bold;font-size:1.08em;">ƒê∆°n c·ªßa t√¥i</span>
                </button>
                <a href="javascript:void(0)" id="cart-btn" style="position:relative;color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;background:#c6eec6;">
                    üõí <span id="cart-count" style="background:#2d7a2d;color:#fff;border-radius:50%;padding:2px 7px;font-size:0.9em;position:absolute;top:2px;right:2px;">0</span>
                </a>
                <!-- Li√™n h·ªá Zalo -->
                <a href="https://zalo.me/0867544809" target="_blank" style="display:flex;align-items:center;gap:4px;color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 14px;border-radius:6px;transition:background 0.2s;background:#e0f7fa;">
                    <img src="https://stc-zaloprofile.zdn.vn/pc/v1/images/zalo_sharelogo.png" alt="Zalo" style="height:22px;width:22px;border-radius:4px;">
                    Zalo
                </a>
                <!-- B·ªè n√∫t t·∫£i app PWA -->
            </div>
        </div>
        <style>
            nav a, nav button#view-my-orders-btn {
                transition: background 0.18s, color 0.18s;
            }
            nav a:hover, nav button#view-my-orders-btn:hover {
                background: #b6e5b6 !important;
                color: #145214 !important;
            }
            nav a:active, nav button#view-my-orders-btn:active {
                background: #a0dca0 !important;
            }
            @media (max-width: 900px) {
                nav > div {
                    flex-wrap: wrap !important;
                    gap: 6px !important;
                    justify-content: center !important;
                }
            }
            @media (max-width: 700px) {
                nav > div {
                    flex-direction: column !important;
                    align-items: stretch !important;
                    gap: 4px !important;
                }
                nav a, nav button#view-my-orders-btn {
                    font-size: 0.93em !important;
                    padding: 4px 7px !important;
                    margin-bottom: 2px !important;
                }
                #cart-count {
                    font-size: 0.85em !important;
                    padding: 1px 5px !important;
                    top: 1px !important;
                    right: 1px !important;
                }
            }
            @media (max-width: 480px) {
                nav {
                    padding: 2px 0 2px 0 !important;
                }
                nav a, nav button#view-my-orders-btn {
                    font-size: 0.89em !important;
                    padding: 3px 4px !important;
                }
            }
        </style>
    </nav>
    <!-- Cart Popup -->
    <div id="cart-popup" style="display:none;position:fixed;top:70px;right:20px;z-index:9999;background:#fff;border-radius:10px;box-shadow:0 4px 24px rgba(45,122,45,0.18);padding:18px 18px 10px 18px;min-width:270px;max-width:90vw;">
        <div style="font-weight:bold;color:#217a21;font-size:1.1em;margin-bottom:10px;">Gi·ªè h√†ng</div>
        <div id="cart-items"></div>
        <button id="close-cart" style="margin-top:10px;background:#2d7a2d;color:#fff;border:none;padding:6px 18px;border-radius:6px;cursor:pointer;">ƒê√≥ng</button>
    </div>
    <div class="container">
        <!-- Khung header s·∫£n ph·∫©m g·ªìm logo, t√¨m ki·∫øm, ti√™u ƒë·ªÅ -->
        <div style="background:#fff;border-radius:14px;box-shadow:0 2px 12px #b6e5b6;padding:18px 12px 18px 12px;max-width:700px;margin:0 auto 24px auto;display:flex;flex-direction:column;align-items:center;">
            <img src="logo.jpg" alt="H'FARM Logo" style="width:100%;max-width:100%;height:auto;display:block;margin:0 auto 12px auto;border-radius:12px;box-shadow:0 1px 8px #b6e5b6;">
            <div style="width:100%;display:flex;justify-content:center;align-items:center;margin-bottom:14px;position:relative;">
                <input id="product-search-input" type="text" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." autocomplete="off"
                    style="width:100%;max-width:420px;padding:10px 14px;border-radius:8px;border:1.5px solid #b6e5b6;font-size:1.08em;outline:none;box-sizing:border-box;">
                <div id="search-suggestions" style="position:absolute;top:110%;left:0;right:0;z-index:100;background:#fff;border-radius:0 0 8px 8px;box-shadow:0 2px 12px #b6e5b633;max-width:420px;margin:0 auto;display:none;"></div>
            </div>
            <h1 style="margin:0 0 0 0;">Danh S√°ch S·∫£n Ph·∫©m</h1>
        </div>
        <div id="product-list">
            <div style="text-align:center;color:#388e3c;font-size:1.1em;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
        <!-- X√≥a n√∫t XEM ƒê∆†N ƒê√É ƒê·∫∂T C·ª¶A T√îI ·ªü ƒë√¢y, v√¨ ƒë√£ ƒë∆∞a l√™n nav -->
    </div>
    <!-- Popup ch·ªçn gi√° -->
    <div id="price-popup-overlay" class="price-popup-overlay" style="display:none;">
        <div class="price-popup">
            <h3>Ch·ªçn dung t√≠ch/gi√°</h3>
            <select id="popup-price-select"></select>
            <div style="margin-top:10px;">
                <button id="popup-add-cart-btn">Th√™m v√†o gi·ªè</button>
                <button class="cancel-btn" id="popup-cancel-btn">H·ªßy</button>
            </div>
        </div>
    </div>
    <!-- Popup xem ƒë∆°n ƒë√£ ƒë·∫∑t -->
    <div id="my-orders-popup" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:rgba(0,0,0,0.22);align-items:center;justify-content:center;">
        <div style="background:#fff;padding:32px 22px 18px 22px;border-radius:16px;box-shadow:0 4px 32px #b6e5b6;min-width:340px;max-width:98vw;max-height:92vh;overflow:auto;position:relative;">
            <div style="font-weight:bold;color:#217a21;font-size:1.18em;margin-bottom:18px;text-align:center;letter-spacing:1px;">
                <span style="font-size:1.25em;">üßæ</span> ƒê∆†N ƒê√É ƒê·∫∂T C·ª¶A T√îI
            </div>
            <div id="my-orders-list"></div>
            <button id="close-my-orders-btn" style="margin-top:16px;background:#e53935;color:#fff;border:none;padding:8px 28px;border-radius:8px;cursor:pointer;font-size:1.08em;display:block;margin-left:auto;margin-right:auto;">ƒê√≥ng</button>
        </div>
    </div>
    <footer style="text-align:center; color:#2d7a2d; font-size:1em; margin:28px 0 12px 0; letter-spacing:1px;">
        H'FARM 95 QU·∫¢NG ƒê·ª®C - NHA TRANG  - KH√ÅNH H√íA<br>
        &copy; 2025 BY Minh Khoa
    </footer>
    <script>
        // --- CART LOGIC ---
        function getCart() {
            return JSON.parse(localStorage.getItem('cart') || '[]');
        }
        function setCart(cart) {
            try {
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartCount();
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                    alert('Gi·ªè h√†ng ƒë√£ ƒë·∫ßy ho·∫∑c tr√¨nh duy·ªát kh√¥ng cho ph√©p l∆∞u th√™m. Vui l√≤ng x√≥a b·ªõt s·∫£n ph·∫©m trong gi·ªè ho·∫∑c d√πng tr√¨nh duy·ªát kh√°c.');
                } else {
                    throw e;
                }
            }
        }
        function addToCart(product) {
            let cart = getCart();
            let cartId = product.id + (product.price ? '_' + product.price : '');
            let idx = cart.findIndex(p => (p.id + (p.price ? '_' + p.price : '')) === cartId);
            if (idx > -1) {
                cart[idx].qty += 1;
            } else {
                cart.push({...product, qty: 1});
            }
            setCart(cart);
            if (document.getElementById('cart-popup').style.display === 'block') {
                renderCartPopup();
            }
        }
        function removeFromCart(id) {
            let cart = getCart().filter(p => {
                let cartId = p.id + (p.price ? '_' + encodeURIComponent(p.price) : '');
                return cartId !== id;
            });
            setCart(cart);
            renderCartPopup();
        }
        function updateCartCount() {
            let cart = getCart();
            document.getElementById('cart-count').textContent = cart.reduce((sum, p) => sum + p.qty, 0);
        }
        function renderCartPopup() {
            let cart = getCart();
            let html = '';
            if (cart.length === 0) {
                html = '<div style="color:#888;text-align:center;">Gi·ªè h√†ng tr·ªëng.</div>';
            } else {
                let total = 0;
                html = `<table class="cart-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√äN H√ÄNG</th>
                            <th>DUNG T√çCH</th>
                            <th>GI√Å</th>
                            <th>S·ªê L∆Ø·ª¢NG</th>
                            <th>X√ìA</th>
                        </tr>
                    </thead>
                    <tbody>`;
                cart.forEach((item, idx) => {
                    let size = '';
                    let priceVal = '';
                    if (item.price) {
                        const match = item.price.match(/^(.+?):\s*(.+)$/);
                        if (match) {
                            size = match[1];
                            priceVal = match[2];
                        } else {
                            priceVal = item.price;
                        }
                    }
                    let priceNum = 0;
                    let priceStr = priceVal.replace(/[^\d]/g, '');
                    if (priceStr) priceNum = parseInt(priceStr, 10);
                    total += priceNum * (item.qty || 1);

                    html += `<tr>
                        <td>${idx + 1}</td>
                        <td style="text-align:left;">${item.title}</td>
                        <td>${size}</td>
                        <td>${priceVal ? `<span class="cart-item-price">${priceVal}</span>` : ''}</td>
                        <td>
                            <input type="number" min="1" value="${item.qty}" style="width:48px;text-align:center;" data-cart-idx="${idx}" class="cart-qty-input">
                        </td>
                        <td>
                            <button onclick="removeFromCart('${item.id}${item.price ? '_' + encodeURIComponent(item.price) : ''}')" style="background:#e53935;color:#fff;border:none;padding:2px 8px;border-radius:4px;cursor:pointer;">X√≥a</button>
                        </td>
                    </tr>`;
                });
                html += `</tbody>
                    <tfoot>
                        <tr class="cart-total-row">
                            <td colspan="3">T·ªîNG C·ªòNG</td>
                            <td colspan="3" style="text-align:left;font-size:1.1em;">
                                <span id="cart-total">${total.toLocaleString('vi-VN')} ƒë</span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
                <button class="cart-buy-btn" id="cart-buy-btn">MUA H√ÄNG</button>
                `;
            }
            document.getElementById('cart-items').innerHTML = html;

            // G√°n s·ª± ki·ªán thay ƒë·ªïi s·ªë l∆∞·ª£ng
            document.querySelectorAll('.cart-qty-input').forEach(input => {
                input.addEventListener('change', function() {
                    let idx = parseInt(this.getAttribute('data-cart-idx'));
                    let val = parseInt(this.value);
                    if (isNaN(val) || val < 1) val = 1;
                    let cart = getCart();
                    cart[idx].qty = val;
                    setCart(cart);
                    renderCartPopup();
                });
            });

            // G√°n s·ª± ki·ªán g·ª≠i ƒë∆°n h√†ng qua Zalo v√† l∆∞u Github
            const buyBtn = document.getElementById('cart-buy-btn');
            if (buyBtn) {
                buyBtn.onclick = function() {
                    let cart = getCart();
                    if (!cart.length) return;
                    let customer = getCustomerInfo();
                    let total = cart.reduce((sum, item) => {
                        let priceVal = '';
                        if (item.price) {
                            const match = item.price.match(/^(.+?):\s*(.+)$/);
                            if (match) priceVal = match[2];
                            else priceVal = item.price;
                        }
                        let priceNum = 0;
                        let priceStr = priceVal.replace(/[^\d]/g, '');
                        if (priceStr) priceNum = parseInt(priceStr, 10);
                        return sum + priceNum * (item.qty || 1);
                    }, 0);

                    showOrderConfirmPopup(cart, customer, function(newCustomer) {
                        // Sau khi x√°c nh·∫≠n, ti·∫øn h√†nh ƒë·∫∑t h√†ng
                        // Hi·ªán popup ti·∫øn tr√¨nh ƒë·∫∑t h√†ng
                        showOrderProgressPopup();

                        let msg = 'ƒê∆†N H√ÄNG H-FARM%0A';
                        msg += cart.map((item, idx) => {
                            let size = '';
                            let priceVal = '';
                            if (item.price) {
                                const match = item.price.match(/^(.+?):\s*(.+)$/);
                                if (match) {
                                    size = match[1];
                                    priceVal = match[2];
                                } else {
                                    priceVal = item.price;
                                }
                            }
                            return `${idx + 1}. ${item.title}${size ? ' - ' + size : ''} - ${priceVal ? priceVal : ''} x${item.qty}`;
                        }).join('%0A');
                        let total = 0;
                        cart.forEach(item => {
                            let priceVal = '';
                            if (item.price) {
                                const match = item.price.match(/^(.+?):\s*(.+)$/);
                                if (match) priceVal = match[2];
                                else priceVal = item.price;
                            }
                            let priceNum = 0;
                            let priceStr = priceVal.replace(/[^\d]/g, '');
                            if (priceStr) priceNum = parseInt(priceStr, 10);
                            total += priceNum * (item.qty || 1);
                        });
                        msg += `%0A--------------------%0AT·ªïng c·ªông: ${total.toLocaleString('vi-VN')} ƒë`;
                        msg += `%0A--------------------%0A${newCustomer.name} - ${newCustomer.phone}${newCustomer.address ? ' - ' + newCustomer.address : ''}`;
                        // L∆∞u ƒë∆°n l√™n Github
                        saveOrderToGithub({
                            customer: {
                                name: newCustomer.name,
                                phone: newCustomer.phone,
                                address: newCustomer.address
                            },
                            payment: newCustomer.payment,
                            shipper: newCustomer.shipper,
                            items: cart,
                            total,
                            created: new Date().toISOString(),
                            orderId: newCustomer.orderId
                        }, function(success, orderId) {
                            // ƒê√≥ng popup ti·∫øn tr√¨nh v√† b√°o k·∫øt qu·∫£ tr√™n popup
                            updateOrderProgressPopup(success);
                            if (success) {
                                setCart([]);
                                renderCartPopup();
                            }
                        });
                    }, total);
                };
            }
        }
        document.getElementById('cart-btn').onclick = function() {
            renderCartPopup();
            document.getElementById('cart-popup').style.display = 'block';
        };
        document.getElementById('close-cart').onclick = function() {
            document.getElementById('cart-popup').style.display = 'none';
        };
        updateCartCount();
        // --- END CART LOGIC ---

        let allProducts = [];
        let lastSearch = '';
        let lastSearchResults = [];

        fetch('https://raw.githubusercontent.com/Minhkhoa0611/H-FARM/main/products.json')
            .then(res => res.json())
            .then(data => {
                if (!Array.isArray(data)) throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");
                // S·∫Øp x·∫øp s·∫£n ph·∫©m theo t√™n A-Z (kh√¥ng ph√¢n nh√≥m danh m·ª•c)
                data.sort((a, b) => {
                    const ta = (a.title || '').toLowerCase();
                    const tb = (b.title || '').toLowerCase();
                    if (ta < tb) return -1;
                    if (ta > tb) return 1;
                    return 0;
                });
                allProducts = data;
                renderProductList('');
                // G√°n s·ª± ki·ªán cho n√∫t Th√™m v√†o gi·ªè
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = btn.getAttribute('data-id');
                        const title = decodeURIComponent(btn.getAttribute('data-title'));
                        const pricesRaw = btn.getAttribute('data-prices');
                        let prices = [];
                        try { prices = pricesRaw ? JSON.parse(pricesRaw) : []; } catch {}
                        if (Array.isArray(prices) && prices.length > 1) {
                            // Hi·ªán popup ch·ªçn gi√°
                            showPricePopup(id, title, prices);
                        } else {
                            // 1 gi√° ho·∫∑c kh√¥ng c√≥ gi√°
                            let price = '';
                            if (prices.length === 1) price = prices[0].price;
                            addToCart({
                                id,
                                title,
                                price
                            });
                        }
                    });
                });

                // Popup ch·ªçn gi√° logic
                function showPricePopup(id, title, prices) {
                    const overlay = document.getElementById('price-popup-overlay');
                    const select = document.getElementById('popup-price-select');
                    select.innerHTML = `<option value="">-- Ch·ªçn dung t√≠ch/gi√° --</option>` +
                        prices.map(p =>
                            `<option value="${p.price.replace(/"/g, '&quot;')}">${p.size ? p.size + ': ' : ''}${p.price}</option>`
                        ).join('');
                    overlay.style.display = 'flex';
                    // S·ª± ki·ªán n√∫t th√™m v√†o gi·ªè
                    document.getElementById('popup-add-cart-btn').onclick = function() {
                        const price = select.value;
                        if (!price) {
                            select.style.border = '2px solid #e53935';
                            select.focus();
                            setTimeout(() => { select.style.border = ''; }, 1200);
                            return;
                        }
                        addToCart({ id, title, price });
                        overlay.style.display = 'none';
                    };
                    document.getElementById('popup-cancel-btn').onclick = function() {
                        overlay.style.display = 'none';
                    };
                }
            })
            .catch(() => {
                document.getElementById('product-list').innerHTML = '<div style="color:#e53935;text-align:center;">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu s·∫£n ph·∫©m!</div>';
            });

        // --- T√¨m ki·∫øm s·∫£n ph·∫©m ---
        const searchInput = document.getElementById('product-search-input');
        const suggestionBox = document.getElementById('search-suggestions');
        searchInput.addEventListener('input', function() {
            const keyword = this.value.trim().toLowerCase();
            if (!keyword) {
                suggestionBox.style.display = 'none';
                renderProductList('');
                return;
            }
            // G·ª£i √Ω autocomplete
            const suggestions = allProducts
                .filter(p => (p.title || '').toLowerCase().includes(keyword))
                .slice(0, 8);
            if (suggestions.length) {
                suggestionBox.innerHTML = suggestions.map(p =>
                    `<div class="search-suggestion-item" style="padding:8px 14px;cursor:pointer;border-bottom:1px solid #f2f8f2;" data-title="${p.title.replace(/"/g,'&quot;')}">${p.title}</div>`
                ).join('');
                suggestionBox.style.display = '';
            } else {
                suggestionBox.innerHTML = '<div style="padding:8px 14px;color:#888;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>';
                suggestionBox.style.display = '';
            }
            // Hi·ªÉn th·ªã s·∫£n ph·∫©m kh·ªõp l√™n ƒë·∫ßu
            renderProductList(keyword);
        });
        // ·∫®n g·ª£i √Ω khi blur (tr·ªÖ ƒë·ªÉ click ch·ªçn)
        searchInput.addEventListener('blur', function() {
            setTimeout(()=>{ suggestionBox.style.display = 'none'; }, 180);
        });
        // Ch·ªçn g·ª£i √Ω
        suggestionBox.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('search-suggestion-item')) {
                searchInput.value = e.target.getAttribute('data-title');
                suggestionBox.style.display = 'none';
                renderProductList(searchInput.value.trim().toLowerCase());
            }
        });

        // H√†m render danh s√°ch s·∫£n ph·∫©m theo t·ª´ kh√≥a
        function renderProductList(keyword) {
            let data = allProducts.slice();
            let matched = [], others = [];
            if (keyword) {
                data.forEach(prod => {
                    if ((prod.title || '').toLowerCase().includes(keyword)) matched.push(prod);
                    else others.push(prod);
                });
                data = matched.concat(others);
            }
            let html = '<div class="product-grid">';
            data.forEach((prod, idx) => {
                const prodId = prod.id || (prod.title + '_' + idx).replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const safeImage = prod.image ? prod.image : '';
                const safeLink = prod.link ? prod.link : '';
                const safeTitle = prod.title ? prod.title : '';
                let priceHtml = '';
                if (Array.isArray(prod.prices) && prod.prices.length) {
                    priceHtml = `<div class="product-price-list">` +
                        prod.prices.map(p =>
                            `<div class="price-row">${p.size ? `<span>${p.size}:</span>` : ''} <span style="font-weight:bold;color:#1a5e1a">${p.price}</span></div>`
                        ).join('') +
                        `</div>`;
                }
                html += `
                    <div class="product-card">
                        ${safeImage ? `<img class="product-img" src="${safeImage}" alt="${safeTitle}">` : ''}
                        <div class="product-card-content">
                            <div class="product-title">${safeTitle}</div>
                            ${priceHtml}
                            ${prod.note ? `<div class="product-note">${prod.note}</div>` : ''}
                            <a class="product-detail-link" href="${safeLink}" target="_blank" style="color:#217a21;text-decoration:underline;font-size:0.98em;">Xem chi ti·∫øt</a>
                            <button class="add-to-cart-btn"
                                data-id="${prodId}"
                                data-title="${encodeURIComponent(safeTitle)}"
                                data-image="${encodeURIComponent(safeImage)}"
                                data-link="${encodeURIComponent(safeLink)}"
                                data-prices='${prod.prices ? JSON.stringify(prod.prices) : ""}'
                                style="background:#2d7a2d;color:#fff;border:none;padding:6px 18px;border-radius:6px;cursor:pointer;font-size:1em;">
                                Th√™m v√†o gi·ªè
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('product-list').innerHTML = html;

            // G√°n l·∫°i s·ª± ki·ªán cho n√∫t Th√™m v√†o gi·ªè sau khi render l·∫°i
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = btn.getAttribute('data-id');
                    const title = decodeURIComponent(btn.getAttribute('data-title'));
                    const pricesRaw = btn.getAttribute('data-prices');
                    let prices = [];
                    try { prices = pricesRaw ? JSON.parse(pricesRaw) : []; } catch {}
                    if (Array.isArray(prices) && prices.length > 1) {
                        showPricePopup(id, title, prices);
                    } else {
                        let price = '';
                        if (prices.length === 1) price = prices[0].price;
                        addToCart({
                            id,
                            title,
                            price
                        });
                    }
                });
            });
        }
    </script>
</body>
</html>