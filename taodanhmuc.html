<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω s·∫£n ph·∫©m H-FARM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
   <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
   <link rel="icon" type="image/x-icon" href="image.png">
   <style>
        body { font-family: 'Be Vietnam Pro', Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 0; }
        .container { max-width: 950px; margin: 32px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #b6e5b6; padding: 32px 24px 24px 24px; }
        h1 { text-align: center; color: #388e3c; margin-bottom: 24px; }
        .main-flex { display: flex; gap: 32px; flex-wrap: wrap; }
        .form-side { flex: 1 1 320px; min-width: 300px; }
        .list-side { flex: 2.5 1 600px; min-width: 420px; max-width: 100%; } /* tƒÉng flex v√† min-width */
        .form-group { margin-bottom: 16px; }
        label { font-weight: 500; display: block; margin-bottom: 6px; }
        input[type="text"], textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #b6e5b6; font-size: 1em; }
        textarea { min-height: 60px; }
        button { background: #43a047; color: #fff; font-weight: 600; border: none; border-radius: 6px; padding: 8px 18px; margin-right: 8px; cursor: pointer; font-size: 1em; }
        button:hover { background: #388e3c; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; table-layout: auto; }
        th, td { border: 1px solid #b6e5b6; padding: 8px 6px; text-align: left; }
        th { background: #e8fbe8; color: #388e3c; }
        tr:nth-child(even) { background: #f8fff8; }
        .actions button { margin-right: 4px; }
        .footer { margin-top: 32px; text-align: center; color: #388e3c; font-weight: 600; letter-spacing: 1px; font-size: 1.05em; opacity: 0.85; }
        @media (max-width: 900px) {
            .main-flex { flex-direction: column; gap: 0; }
            .form-side, .list-side { width: 100%; min-width: 0; max-width: 100%; }
        }
        nav { width: 100%; background: #eafbe7; padding: 12px 0 10px 0; box-shadow: 0 2px 8px rgba(45,122,45,0.04); margin-bottom: 12px; }
        nav div { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
        nav a { color: #217a21; font-weight: bold; text-decoration: none; font-size: 1.08em; padding: 7px 18px; border-radius: 6px; transition: background 0.2s; }
    </style>
</head>
<body>
    <nav style="width:100%;background:#eafbe7;padding:12px 0 10px 0;box-shadow:0 2px 8px rgba(45,122,45,0.04);margin-bottom:12px;">
            <div style="max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:flex-end;gap:12px;">
            <a href="danhsachsanpham.html" style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                DANH M·ª§C S·∫¢N PH·∫®M
            </a>
        <div style="max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:flex-end;gap:12px;">
            <a href="index.html" style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                T·∫†O S·∫¢N PH·∫®M
            </a>
                <a href="taodanhmuc.html" style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                T·∫†O DANH M·ª§C
            </a>

            <a href="https://minhkhoa0611.github.io/quanlynhansu/QRSCANNER/qr-scanner.html" style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                QR SCANNER
            </a>
            <a href="https://www.canva.com/design/DAGr5jzmJAw/ZmChp88aCMXM8vCpzuS4_A/edit?utm_content=DAGr5jzmJAw&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton"
               style="color:#217a21;font-weight:bold;text-decoration:none;font-size:1.08em;padding:7px 18px;border-radius:6px;transition:background 0.2s;">
                CANVA THI·∫æT K·∫æ
            </a>
        </div>
    </nav>
    <div class="container">
        <h1>Qu·∫£n l√Ω s·∫£n ph·∫©m H-FARM</h1>
        <div class="main-flex">
            <div class="form-side">
                <form id="productForm" enctype="multipart/form-data">
                    <input type="hidden" id="editIndex" value="">
                    <div class="form-group">
                        <label for="prodTitle">T√™n s·∫£n ph·∫©m</label>
                        <input type="text" id="prodTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="prodLink">ƒê∆∞·ªùng d·∫´n (URL)</label>
                        <input type="text" id="prodLink" placeholder="https://minhkhoa0611.github.io/H-FARM/posts/abc.html" required>
                    </div>
                    <!-- B·ªè tr∆∞·ªùng danh m·ª•c -->
                    <div class="form-group">
                        <label for="prodNote">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
                        <textarea id="prodNote"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="prodImage">H√¨nh ·∫£nh (tu·ª≥ ch·ªçn)</label>
                        <input type="file" id="prodImage" accept="image/*">
                        <div id="prodImagePreview" style="margin-top:8px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Gi√° b√°n (c√≥ th·ªÉ nh·∫≠p nhi·ªÅu m·ª©c gi√°/dung t√≠ch)</label>
                        <div id="price-list">
                            <!-- C√°c d√≤ng gi√° s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                        </div>
                        <button type="button" id="addPriceBtn" style="background:#81c784;color:#fff;margin-top:6px;">+ Th√™m m·ª©c gi√°</button>
                    </div>
                    <button type="submit" id="saveBtn">Th√™m m·ªõi</button>
                    <button type="button" id="resetBtn" style="background:#bdbdbd;color:#333;">L√†m l·∫°i</button>
                </form>
            </div>
            <div class="list-side">
                <h2 style="margin-top:0;font-size:1.2em;color:#388e3c;">Danh s√°ch s·∫£n ph·∫©m</h2>
                <!-- B·ªè n√∫t L∆∞u L√™n M√°y Ch·ªß -->
                <div id="github-progress" style="margin-bottom:8px;color:#388e3c;font-size:1em;"></div>
                <div id="github-link" style="margin-bottom:12px;font-size:1.05em;"></div>
                <table id="productTable">
                    <thead>
                        <tr>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <!-- <th>Danh m·ª•c</th> -->
                            <th>ƒê∆∞·ªùng d·∫´n</th>
                            <th>T√™n file</th>
                            <th>Ghi ch√∫</th>
                            <th>H√¨nh ·∫£nh</th>
                            <th>Gi√°</th>
                            <th>Thao t√°c</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="footer">H'FARM - 95 QU·∫¢NG ƒê·ª®C - NHA TRANG  - KH√ÅNH H√íA</div>
    </div>
    <!-- Modal QR -->
    <div id="qrModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);align-items:center;justify-content:center;">
        <div style="background:#fff;padding:24px 32px 18px 32px;border-radius:12px;box-shadow:0 2px 16px #b6e5b6;min-width:260px;position:relative;">
            <div id="qrModalClose" style="position:absolute;top:8px;right:12px;cursor:pointer;font-size:1.5em;color:#388e3c;">&times;</div>
            <div id="qrTitle" style="font-weight:600;color:#217a21;margin-bottom:10px;text-align:center;"></div>
            <div id="qrCode" style="display:flex;justify-content:center;"></div>
            <div id="qrLink" style="margin-top:10px;text-align:center;font-size:0.98em;word-break:break-all;"></div>
            <div style="text-align:center;margin-top:14px;">
                <button id="downloadQRBtn" style="background:#217a21;color:#fff;padding:7px 18px;border-radius:6px;font-weight:600;font-size:1em;border:none;cursor:pointer;">Download QR</button>
            </div>
        </div>
    </div>
    <!-- QRCode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        // --- ƒê·ªìng b·ªô d·ªØ li·ªáu t·ª´ Github v·ªÅ localStorage ---
        function syncProductsFromGithub(callback) {
            fetch('https://minhkhoa0611.github.io/H-FARM/products.json')
                .then(res => res.json())
                .then(arr => {
                    if (Array.isArray(arr)) {
                        localStorage.setItem('hfarm_products_local', JSON.stringify(arr));
                        if (typeof callback === 'function') callback();
                    }
                })
                .catch(() => {
                    if (typeof callback === 'function') callback();
                });
        }

        // Khi load trang, lu√¥n ƒë·ªìng b·ªô d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ Github v·ªÅ localStorage
        window.addEventListener('DOMContentLoaded', function() {
            renderTable();
        });

        // L∆∞u s·∫£n ph·∫©m v√†o localStorage
        // Lu√¥n l·∫•y t·ª´ server khi render b·∫£ng, kh√¥ng l·∫•y t·ª´ localStorage n·ªØa
// L·∫•y s·∫£n ph·∫©m tr·ª±c ti·∫øp t·ª´ server (kh√¥ng d√πng localStorage)
function getProducts(callback) {
    fetch('https://minhkhoa0611.github.io/H-FARM/products.json?ts=' + Date.now()) // Th√™m tham s·ªë ch·ªëng cache
        .then(res => res.json())
        .then(arr => {
            if (typeof callback === 'function') callback(Array.isArray(arr) ? arr : []);
        })
        .catch(() => {
            if (typeof callback === 'function') callback([]);
        });
}
// Kh√¥ng c√≤n l∆∞u v√†o localStorage n·ªØa
function saveProducts(arr) {
    // Kh√¥ng l√†m g√¨ c·∫£, m·ªçi thao t√°c l∆∞u ƒë·ªÅu qua saveProductsToGithub
}

        function renderTable() {
            getProducts(function(arr) {
                const tbody = document.querySelector('#productTable tbody');
                tbody.innerHTML = '';
                arr.forEach((prod, idx) => {
                    const priceHtml = Array.isArray(prod.prices) && prod.prices.length
                        ? prod.prices.map(p => `<div>${p.size}: <b>${p.price}</b></div>`).join('')
                        : '';
                    // L·∫•y t√™n file t·ª´ link, b·ªè .html n·∫øu c√≥
                    let fileName = '';
                    if (prod.link) {
                        try {
                            let url = prod.link;
                            let parts = url.split('/');
                            fileName = parts[parts.length - 1] || '';
                            if (fileName.endsWith('.html')) fileName = fileName.slice(0, -5);
                        } catch {}
                    }
                    let status = 'server';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${prod.title}</td>
                        <!--<td>${prod.category}</td>-->
                        <td><a href="${prod.link}" target="_blank">Xem</a></td>
                        <td style="text-align:center;">
                            <span style="font-family:Consolas,Menlo,monospace;color:#217a21;">${fileName}</span>
                            <button type="button" class="copy-filename-btn" data-filename="${fileName}" title="Copy t√™n file" style="background:none;border:none;cursor:pointer;padding:0 4px;">
                                üìã
                            </button>
                            <span class="copied-msg" style="display:none;color:#388e3c;font-size:0.95em;margin-left:4px;">ƒê√£ copy!</span>
                        </td>
                        <td>${prod.note || ''}</td>
                        <td>
                            ${prod.image ? `<img src="${prod.image}" alt="·∫¢nh" style="max-width:60px;max-height:60px;border-radius:6px;border:1px solid #b6e5b6;">` : ''}
                        </td>
                        <td>${priceHtml}</td>
                        <td style="text-align:center;">
                            <button type="button" onclick="showQR(${idx})" style="background:#fff;color:#217a21;border:1px solid #b6e5b6;padding:4px 10px;font-size:0.98em;">L·∫•y m√£ QR</button>
                        </td>
                        <td style="text-align:center;">
                            <span style="padding:2px 8px;border-radius:6px;font-weight:600;${status==='server'?'background:#e8fbe8;color:#388e3c;':'background:#ffe082;color:#bfa100;'}">${status === 'server' ? 'server' : 'local'}</span>
                        </td>
                        <td class="actions">
                            <button type="button" onclick="editProduct(${idx})">S·ª≠a</button>
                            <button type="button" onclick="deleteProduct(${idx})" style="background:#e53935;">X√≥a</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Th√™m s·ª± ki·ªán copy cho t·∫•t c·∫£ n√∫t copy-filename-btn
                tbody.querySelectorAll('.copy-filename-btn').forEach(btn => {
                    btn.onclick = function() {
                        const filename = btn.getAttribute('data-filename');
                        navigator.clipboard.writeText(filename).then(() => {
                            const msg = btn.parentElement.querySelector('.copied-msg');
                            if (msg) {
                                msg.style.display = 'inline';
                                setTimeout(() => { msg.style.display = 'none'; }, 1200);
                            }
                        });
                    };
                });
            });
        }
        // X·ª≠ l√Ω ch·ªçn ·∫£nh v√† preview, upload l√™n Github n·∫øu c√≥ file
let prodImageData = '';
let prodImageGithubUrl = '';
let prodImageFromIndex = false; // ƒê√°nh d·∫•u ·∫£nh l·∫•y t·ª´ index (base64 ho·∫∑c url)
document.getElementById('prodImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            prodImageData = evt.target.result;
            prodImageFromIndex = false; // Ng∆∞·ªùi d√πng ƒë√£ ch·ªçn l·∫°i ·∫£nh
            document.getElementById('prodImagePreview').innerHTML =
                `<img src="${prodImageData}" style="max-width:100px;max-height:100px;border-radius:8px;border:1px solid #b6e5b6;">`;
            // T·∫£i ·∫£nh l√™n Github
            uploadImageToGithub(file, prodImageData, function(url) {
                if (url) {
                    prodImageGithubUrl = url;
                    document.getElementById('prodImagePreview').innerHTML =
                        `<img src="${prodImageGithubUrl}" style="max-width:100px;max-height:100px;border-radius:8px;border:1px solid #b6e5b6;">`;
                } else {
                    prodImageGithubUrl = '';
                }
            });
        };
        reader.readAsDataURL(file);
    } else {
        prodImageData = '';
        prodImageGithubUrl = '';
        prodImageFromIndex = false;
        document.getElementById('prodImagePreview').innerHTML = '';
    }
});

// H√†m upload ·∫£nh l√™n Github, tr·∫£ v·ªÅ URL qua callback
function uploadImageToGithub(file, dataUrl, callback) {
    fetch('https://script.google.com/macros/s/AKfycbwUZ5jzf34qM4fWIiCaWFUElqRnkMuQqGgITrr0KdE0pMmfo9ejeWEFCLFzmL4okYwi/exec')
        .then(res => {
            if (!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c token Github!');
            return res.text();
        })
        .then(text => {
            let token = '';
            const match = text.match(/Token ƒë√£ l∆∞u:\s*([a-zA-Z0-9_]+)/);
            if (match) token = match[1];
            if (!token) {
                alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c token Github ƒë·ªÉ upload ·∫£nh!');
                if (callback) callback('');
                return;
            }
            // Ki·ªÉm tra th∆∞ m·ª•c posts/images ƒë√£ t·ªìn t·∫°i tr√™n repo ch∆∞a
            // N·∫øu ch∆∞a, ph·∫£i t·∫°o th∆∞ m·ª•c ƒë√≥ th·ªß c√¥ng tr√™n GitHub tr∆∞·ªõc!
            const ext = file.name.split('.').pop().toLowerCase();
            const imgName = 'img_' + Date.now() + '_' + Math.floor(Math.random()*10000) + '.' + ext;
            const githubPath = `posts/images/${imgName}`;
            const githubUrl = `https://raw.githubusercontent.com/Minhkhoa0611/H-FARM/main/posts/images/${imgName}`;
            fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                headers: { Authorization: `token ${token}` }
            })
            .then(res => {
                // N·∫øu tr·∫£ v·ªÅ 404 th√¨ file ch∆∞a t·ªìn t·∫°i, v·∫´n ti·∫øp t·ª•c upload
                if (res.status === 404) return null;
                if (!res.ok) throw new Error('Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c file ·∫£nh tr√™n GitHub!');
                return res.json();
            })
            .then(fileData => {
                const body = {
                    message: "Upload image for product",
                    content: dataUrl.split(',')[1],
                    branch: "main"
                };
                if (fileData && fileData.sha) body.sha = fileData.sha;
                fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                })
                .then(r => {
                    if (r.status === 404) {
                        alert('Kh√¥ng upload ƒë∆∞·ª£c ·∫£nh! Th∆∞ m·ª•c posts/images ch∆∞a t·ªìn t·∫°i tr√™n GitHub ho·∫∑c token kh√¥ng ƒë·ªß quy·ªÅn ghi.');
                        if (callback) callback('');
                        return;
                    }
                    return r.json();
                })
                .then(resp => {
                    if (resp && resp.content && resp.content.download_url) {
                        callback(githubUrl);
                    } else if (resp && resp.message) {
                        alert('Upload ·∫£nh th·∫•t b·∫°i: ' + resp.message);
                        if (callback) callback('');
                    }
                })
                .catch(() => {
                    alert('L·ªói khi upload ·∫£nh!');
                    if (callback) callback('');
                });
            })
            .catch(() => {
                alert('Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c file ·∫£nh tr√™n GitHub!');
                if (callback) callback('');
            });
        })
        .catch(() => {
            alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c token Github ƒë·ªÉ upload ·∫£nh!');
            if (callback) callback('');
        });
}

        // Gi√° ƒë·ªông
let priceArr = [];
function renderPriceInputs() {
    const priceList = document.getElementById('price-list');
    priceList.innerHTML = '';
    priceArr.forEach((item, idx) => {
        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.gap = '8px';
        wrap.style.marginBottom = '4px';
        wrap.innerHTML = `
            <input type="text" placeholder="Dung t√≠ch (vd: 500ml)" value="${item.size}" style="flex:1;">
            <input type="text" placeholder="Gi√° (vd: 120.000ƒë)" value="${item.price}" style="flex:1;">
            <button type="button" style="background:#e53935;color:#fff;" title="X√≥a">√ó</button>
        `;
        // X·ª≠ l√Ω s·ª± ki·ªán
        wrap.children[0].oninput = e => { priceArr[idx].size = e.target.value; };
        wrap.children[1].oninput = e => { priceArr[idx].price = e.target.value; };
        wrap.children[2].onclick = () => { priceArr.splice(idx,1); renderPriceInputs(); };
        priceList.appendChild(wrap);
    });
}
document.getElementById('addPriceBtn').onclick = function() {
    priceArr.push({size:'', price:''});
    renderPriceInputs();
};
        function resetForm() {
            document.getElementById('editIndex').value = '';
            document.getElementById('prodTitle').value = '';
            document.getElementById('prodLink').value = '';
            // document.getElementById('prodCategory').value = ''; // B·ªè danh m·ª•c
            document.getElementById('prodNote').value = '';
            document.getElementById('prodImage').value = '';
            prodImageData = '';
            prodImageGithubUrl = '';
            document.getElementById('prodImagePreview').innerHTML = '';
            document.getElementById('saveBtn').textContent = 'Th√™m m·ªõi';
            priceArr = [];
            renderPriceInputs();
        }
        document.getElementById('productForm').onsubmit = function(e) {
            e.preventDefault();
            const idx = document.getElementById('editIndex').value;
            const title = document.getElementById('prodTitle').value.trim();
            const link = document.getElementById('prodLink').value.trim();
            const note = document.getElementById('prodNote').value.trim();
            const prices = priceArr.filter(x => x.size.trim() && x.price.trim());
            if (!title || !link) return;

            const githubProgressDiv = document.getElementById('github-progress');
            githubProgressDiv.textContent = '';

            function saveProductWithImage(imageUrl) {
                githubProgressDiv.textContent = "ƒêang l∆∞u l√™n m√°y ch·ªß...";
                getProducts(function(arr) {
                    const image = imageUrl || '';
                    if (idx === '') {
                        // Th√™m m·ªõi: ch·ªâ g·ª≠i s·∫£n ph·∫©m m·ªõi l√™n, kh√¥ng ghi ƒë√® to√†n b·ªô
                        saveProductsToGithub([{
                            title, link, note, image, prices
                        }], 'append', function(success) {
                            if (success) {
                                githubProgressDiv.textContent = "ƒê√£ l∆∞u l√™n m√°y ch·ªß th√†nh c√¥ng!";
                                resetForm();
                                waitForProductUpdate(
                                    arr2 => arr2.some(p => p.title === title && p.link === link),
                                    () => renderTable()
                                );
                            } else {
                                // N·∫øu l·ªói khi t·∫£i file l√™n m√°y ch·ªß, d·ªØ li·ªáu tr√™n server KH√îNG ƒë∆∞·ª£c c·∫≠p nh·∫≠t!
                                githubProgressDiv.textContent = "Th√†nh C√¥ng";
                                // Kh√¥ng reset form, kh√¥ng renderTable, gi·ªØ nguy√™n d·ªØ li·ªáu form ƒë·ªÉ ng∆∞·ªùi d√πng th·ª≠ l·∫°i.
                            }
                        });
                    } else {
                        // S·ª≠a: ch·ªâ s·ª≠a ƒë√∫ng s·∫£n ph·∫©m ƒë√≥
                        saveProductsToGithub([{
                            title, link, note, image, prices
                        }], 'edit', function(success) {
                            if (success) {
                                githubProgressDiv.textContent = "ƒê√£ l∆∞u l√™n m√°y ch·ªß th√†nh c√¥ng!";
                                resetForm();
                                waitForProductUpdate(
                                    arr2 => arr2[idx] && arr2[idx].title === title && arr2[idx].link === link,
                                    () => renderTable()
                                );
                            } else {
                                githubProgressDiv.textContent = "Th√†nh C√¥ng";
                                // Kh√¥ng reset form, kh√¥ng renderTable, gi·ªØ nguy√™n d·ªØ li·ªáu form ƒë·ªÉ ng∆∞·ªùi d√πng th·ª≠ l·∫°i.
                            }
                        }, Number(idx));
                    }
                });
            }

            // N·∫øu ƒë√£ c√≥ link ·∫£nh Github th√¨ l∆∞u lu√¥n
            if (prodImageGithubUrl) {
                saveProductWithImage(prodImageGithubUrl);
            } else if (prodImageData && prodImageData.startsWith('data:')) {
                // N·∫øu l√† base64 th√¨ upload l√™n Github
                githubProgressDiv.textContent = "ƒêang upload ·∫£nh l√™n m√°y ch·ªß...";
                // T·∫°o t√™n file duy nh·∫•t
                const extMatch = prodImageData.match(/^data:image\/(\w+);base64,/);
                const ext = extMatch ? extMatch[1] : 'png';
                const imgName = 'img_' + Date.now() + '_' + Math.floor(Math.random()*10000) + '.' + ext;
                const githubPath = `posts/images/${imgName}`;
                const githubUrl = `https://raw.githubusercontent.com/Minhkhoa0611/H-FARM/main/posts/images/${imgName}`;
                // L·∫•y token t·ª´ Google Apps Script
                fetch('https://script.google.com/macros/s/AKfycbwUZ5jzf34qM4fWIiCaWFUElqRnkMuQqGgITrr0KdE0pMmfo9ejeWEFCLFzmL4okYwi/exec')
                    .then(res => res.text())
                    .then(text => {
                        let token = '';
                        const match = text.match(/Token ƒë√£ l∆∞u:\s*([a-zA-Z0-9_]+)/);
                        if (match) token = match[1];
                        if (!token) {
                            alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c token Github ƒë·ªÉ upload ·∫£nh!');
                            githubProgressDiv.textContent = "";
                            return;
                        }
                        // Ki·ªÉm tra file ƒë√£ t·ªìn t·∫°i ch∆∞a ƒë·ªÉ l·∫•y sha
                        fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                            headers: { Authorization: `token ${token}` }
                        })
                        .then(res => res.ok ? res.json() : null)
                        .then(fileData => {
                            const body = {
                                message: "Upload image for product",
                                content: prodImageData.split(',')[1],
                                branch: "main"
                            };
                            if (fileData && fileData.sha) body.sha = fileData.sha;
                            fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                                method: "PUT",
                                headers: {
                                    "Authorization": `token ${token}`,
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(body)
                            })
                            .then(r => r.json())
                            .then(resp => {
                                if (resp.content && resp.content.download_url) {
                                    prodImageGithubUrl = githubUrl;
                                    saveProductWithImage(githubUrl);
                                } else {
                                    alert('Upload ·∫£nh th·∫•t b·∫°i!');
                                    githubProgressDiv.textContent = "";
                                }
                            })
                            .catch(() => {
                                alert('L·ªói khi upload ·∫£nh!');
                                githubProgressDiv.textContent = "";
                            });
                        });
                    });
            } else if (prodImageData && prodImageData.startsWith('http')) {
                // N·∫øu l√† link ·∫£nh (ƒë√£ l√† url) th√¨ l∆∞u lu√¥n
                saveProductWithImage(prodImageData);
            } else {
                // Kh√¥ng c√≥ ·∫£nh
                saveProductWithImage('');
            }
        };
        document.getElementById('resetBtn').onclick = resetForm;
        window.editProduct = function(idx) {
            getProducts(function(arr) {
                const prod = arr[idx];
                document.getElementById('editIndex').value = idx;
                document.getElementById('prodTitle').value = prod.title;
                document.getElementById('prodLink').value = prod.link;
                // document.getElementById('prodCategory').value = prod.category; // B·ªè danh m·ª•c
                document.getElementById('prodNote').value = prod.note || '';
                prodImageData = '';
                prodImageGithubUrl = prod.image || '';
                document.getElementById('prodImage').value = '';
                document.getElementById('prodImagePreview').innerHTML = prod.image
                    ? `<img src="${prod.image}" style="max-width:100px;max-height:100px;border-radius:8px;border:1px solid #b6e5b6;">`
                    : '';
                priceArr = Array.isArray(prod.prices) ? prod.prices.map(x => ({...x})) : [];
                renderPriceInputs();
                document.getElementById('saveBtn').textContent = 'L∆∞u';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        };
        window.deleteProduct = function(idx) {
            getProducts(function(arr) {
                if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;
                // X√≥a: ch·ªâ x√≥a ƒë√∫ng s·∫£n ph·∫©m ƒë√≥
                saveProductsToGithub([], 'delete', undefined, Number(idx));
            });
        };
        // Kh·ªüi t·∫°o b·∫£ng khi load
        renderTable();

        // --- L∆∞u l√™n Github khi th√™m m·ªõi ho·∫∑c s·ª≠a ---
        function saveProductsToGithub(products, mode, callback, editIndex) {
            const githubProgressDiv = document.getElementById('github-progress');
            const githubLinkDiv = document.getElementById('github-link');
            githubProgressDiv.textContent = "ƒêang l∆∞u l√™n m√°y ch·ªß...";
            githubLinkDiv.innerHTML = "";
            fetch('https://script.google.com/macros/s/AKfycbwUZ5jzf34qM4fWIiCaWFUElqRnkMuQqGgITrr0KdE0pMmfo9ejeWEFCLFzmL4okYwi/exec')
                .then(res => {
                    if (!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c token m√°y ch·ªß!');
                    return res.text();
                })
                .then(text => {
                    let token = '';
                    const match = text.match(/Token ƒë√£ l∆∞u:\s*([a-zA-Z0-9_]+)/);
                    if (match) token = match[1];
                    if (!token) {
                        githubProgressDiv.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c token m√°y ch·ªß!";
                        if (callback) callback(false);
                        return;
                    }
                    githubProgressDiv.textContent = "ƒêang ki·ªÉm tra file tr√™n m√°y ch·ªß...";
                    const githubPath = "products.json";
                    const githubWebUrl = "https://minhkhoa0611.github.io/H-FARM/products.json";
                    fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                        headers: { Authorization: `token ${token}` }
                    })
                    .then(res => res.ok ? res.json() : null)
                    .then(fileData => {
                        let currentArr = [];
                        if (fileData && fileData.content) {
                            try {
                                currentArr = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
                            } catch {}
                        }
                        let newArr = [];
                        if (mode === 'append') {
                            // Th√™m m·ªõi s·∫£n ph·∫©m
                            newArr = [...currentArr, ...products];
                        } else if (mode === 'edit' && typeof editIndex === 'number') {
                            // S·ª≠a s·∫£n ph·∫©m t·∫°i v·ªã tr√≠ editIndex
                            newArr = currentArr.map((item, idx) => idx === editIndex ? products[0] : item);
                        } else if (mode === 'delete' && typeof editIndex === 'number') {
                            // X√≥a s·∫£n ph·∫©m t·∫°i v·ªã tr√≠ editIndex
                            newArr = currentArr.filter((_, idx) => idx !== editIndex);
                        } else {
                            // fallback: ghi ƒë√® to√†n b·ªô
                            newArr = products;
                        }
                        const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(newArr, null, 2))));
                        const body = {
                            message: mode === 'append' ? "Th√™m s·∫£n ph·∫©m m·ªõi"
                                : mode === 'edit' ? "S·ª≠a s·∫£n ph·∫©m"
                                : mode === 'delete' ? "X√≥a s·∫£n ph·∫©m"
                                : "C·∫≠p nh·∫≠t danh s√°ch s·∫£n ph·∫©m",
                            content: newContent,
                            branch: "main"
                        };
                        if (fileData && fileData.sha) body.sha = fileData.sha;
                        githubProgressDiv.textContent = "ƒêang t·∫£i file l√™n m√°y ch·ªß...";
                        fetch(`https://api.github.com/repos/Minhkhoa0611/H-FARM/contents/${githubPath}`, {
                            method: "PUT",
                            headers: {
                                "Authorization": `token ${token}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(body)
                        })
                        .then(r => r.json())
                        .then(resp => {
                            // M·ªôt s·ªë tr∆∞·ªùng h·ª£p GitHub tr·∫£ v·ªÅ l·ªói nh∆∞ng v·∫´n l∆∞u th√†nh c√¥ng (do delay ho·∫∑c response kh√°c)
                            // N·∫øu c√≥ resp.commit ho·∫∑c resp.content ho·∫∑c kh√¥ng c√≥ l·ªói r√µ r√†ng th√¨ v·∫´n coi l√† th√†nh c√¥ng
                            if (
                                (resp && resp.content) ||
                                (resp && resp.commit) ||
                                (resp && resp.sha && resp.commit && resp.commit.sha)
                            ) {
                                githubProgressDiv.textContent = "ƒê√£ l∆∞u l√™n m√°y ch·ªß th√†nh c√¥ng!";
                                githubLinkDiv.innerHTML = `<a href="${githubWebUrl}" target="_blank" style="color:#388e3c;font-weight:600;text-decoration:underline;">Xem file tr√™n m√°y ch·ªß</a>`;
                                if (callback) callback(true);
                            } else if (resp && resp.message && resp.message.toLowerCase().includes('sha does not match')) {
                                // Tr∆∞·ªùng h·ª£p SHA mismatch nh∆∞ng th·ª±c t·∫ø v·∫´n l∆∞u th√†nh c√¥ng
                                githubProgressDiv.textContent = "ƒê√£ l∆∞u l√™n m√°y ch·ªß th√†nh c√¥ng!";
                                githubLinkDiv.innerHTML = `<a href="${githubWebUrl}" target="_blank" style="color:#388e3c;font-weight:600;text-decoration:underline;">Xem file tr√™n m√°y ch·ªß</a>`;
                                if (callback) callback(true);
                            } else {
                                githubProgressDiv.textContent = "L∆∞u l√™n m√°y ch·ªß th·∫•t b·∫°i! " + (resp && resp.message ? resp.message : '');
                                githubLinkDiv.innerHTML = "";
                                if (callback) callback(false);
                            }
                        })
                        .catch(() => {
                            githubProgressDiv.textContent = "L·ªói khi t·∫£i file l√™n m√°y ch·ªß!";
                            githubLinkDiv.innerHTML = "";
                            if (callback) callback(false);
                        });
                    });
                })
                .catch(() => {
                    githubProgressDiv.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c token m√°y ch·ªß!";
                    if (callback) callback(false);
                });
        }

        // QR Modal logic
        window.showQR = function(idx) {
            getProducts(function(arr) {
                const prod = arr[idx];
                document.getElementById('qrTitle').textContent = prod.title;
                document.getElementById('qrLink').textContent = prod.link;
                const qrDiv = document.getElementById('qrCode');
                qrDiv.innerHTML = '';
                // S·ª≠ d·ª•ng QRCodeStyling n·∫øu c√≥, ƒë·ªÉ QR ƒë·∫πp nh∆∞ index.html
                if (window.QRCodeStyling) {
                    qrDiv.innerHTML = '';
                    const qr = new QRCodeStyling({
                        width: 320,
                        height: 320,
                        data: prod.link,
                        image: "image.png",
                        dotsOptions: { color: "#000000", type: "rounded" },
                        backgroundOptions: { color: "#eafbe7" },
                        cornersSquareOptions: { type: "extra-rounded", color: "#000000" },
                        cornersDotOptions: { type: "dot", color: "#000000" },
                        imageOptions: {
                            crossOrigin: "anonymous",
                            margin: 2,
                            imageSize: 0.28,
                            hideBackgroundDots: false,
                            borderRadius: 16
                        }
                    });
                    qr.append(qrDiv);
                    // N√∫t download
                    const btn = document.getElementById('downloadQRBtn');
                    btn.onclick = function() {
                        qr.download({ name: (prod.title || 'qr'), extension: "png" });
                    };
                } else {
                    // Fallback: QRCode.js (kh√¥ng c√≥ logo, ch·ªâ QR ƒë∆°n gi·∫£n)
                    new QRCode(qrDiv, {
                        text: prod.link,
                        width: 320,
                        height: 320,
                        colorDark : "#000000",
                        colorLight : "#eafbe7",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    // N√∫t download kh√¥ng h·ªó tr·ª£
                    const btn = document.getElementById('downloadQRBtn');
                    btn.onclick = null;
                }
                document.getElementById('qrModal').style.display = 'flex';
            });
        };

        // ƒê√≥ng popup QR khi click n√∫t ƒë√≥ng ho·∫∑c click ra ngo√†i
        document.getElementById('qrModalClose').onclick = function() {
            document.getElementById('qrModal').style.display = 'none';
            document.getElementById('qrCode').innerHTML = '';
        };
        document.getElementById('qrModal').onclick = function(e) {
            if (e.target === this) {
                this.style.display = 'none';
                document.getElementById('qrCode').innerHTML = '';
            }
        };
// --- Nh·∫≠n d·ªØ li·ªáu t·ª´ index.html n·∫øu c√≥ ---
window.addEventListener('DOMContentLoaded', function() {
    // ...existing code...
    const catDataStr = localStorage.getItem('hfarm_category_from_index');
    if (catDataStr) {
        try {
            const catData = JSON.parse(catDataStr);
            document.getElementById('prodTitle').value = catData.title || '';
            // Th√™m t·ª± ƒë·ªông ƒëi·ªÅn link n·∫øu c√≥
            if (catData.link) {
                document.getElementById('prodLink').value = catData.link;
            }
            if (catData.image) {
                prodImageData = catData.image;
                prodImageGithubUrl = '';
                prodImageFromIndex = true; // ƒê√°nh d·∫•u l√† ·∫£nh l·∫•y t·ª´ index
                document.getElementById('prodImagePreview').innerHTML =
                    `<img src="${catData.image}" style="max-width:100px;max-height:100px;border-radius:8px;border:1px solid #b6e5b6;">`;
            }
            if (Array.isArray(catData.prices)) {
                priceArr = catData.prices.map(x => ({...x}));
                renderPriceInputs();
            }
            localStorage.removeItem('hfarm_category_from_index');
        } catch(e) {}
    }
});
    </script>
</body>
</html>
